# DrZaius Backend

FastAPI backend with clean layers (routers → services → repositories), SQLAlchemy, Alembic, and Pydantic schemas. Error handling is standardized with request IDs and consistent payloads.

## Overview (what this app does)
- DrZaius helps recipients (patients) and caregivers connect, collaborate, and manage medical resources.
- Recipients can invite caregivers (and vice versa), accept/decline invitations, and assign ongoing access.
- Groups let people organize into a team with admins and members; creator is always an admin and can’t be demoted/removed/leave.
- Payment codes can be generated by group admins for future billing workflows.
- Document upload is available today with basic validation; redaction is stubbed for now (later we’ll plug in a provider).

> MVP status: in progress. Security APIs (policies/keys workflows), real DLP redaction, and Vertex RAG integration are pending and will be completed before MVP launch. Current redaction is stubbed, and security endpoints exist but are not feature-complete.

### Who’s who
- Recipient: The person receiving care. Can invite a caregiver.
- Caregiver: The person providing care. Can invite a recipient.
- Group: A small team. One user creates the group and is the “creator admin.”

### Core flows
1) Invitations
   - Send invite by email (caregiver → recipient; recipient → caregiver).
   - Receivers see invites under “received” and can accept or decline.
   - On accept, a caregiver-recipient link is created.
   - Emails can include a deep link token to accept (MVP-ready).

2) Groups
   - Create a group (creator becomes admin).
   - Add/remove members; change roles (admin/member).
   - Guardrails:
     - Creator cannot leave, be removed, or be demoted.
     - There must always be at least one admin (last-admin protection).
   - Members list supports pagination; `X-Total-Count` header is returned.

3) Payment codes (for groups)
   - Admins can create codes (optional TTL).
   - Admins can list and void codes.
   - Any authenticated user can redeem a valid code.

4) Documents (stubbed)
   - Upload a file for a recipient.
   - Basic validation: allowed MIME types (PDF/PNG/JPEG) and max size.
   - Redaction endpoint is stubbed; we’ll integrate a provider later.

### For MVP
- Groups and memberships with admin guardrails and pagination.
- Invitations via email with accept/decline (deep link token ready).
- Payment codes for groups: create/list/void/redeem.
- Stubbed redaction and document upload with basic validation.

## Prerequisites
- Python 3.9+
- PostgreSQL 13+
- Optional: Node/Expo (frontend runs separately)

## Environment
Create `.env` or export variables:

```bash
export DATABASE_URL=postgresql+psycopg2://postgres:postgres@localhost:5432/drzaius
export INVITE_SIGNING_SECRET=dev-invite-secret-change-me
export EMAIL_FROM=no-reply@example.com
# Pipeline & DLP (stubs OK if disabled)
export ENABLE_PIPELINE=false
export ENABLE_DLP=false
# GCP (only needed if enabling providers later)
export GCP_PROJECT_ID=""
export GCP_LOCATION=us-central1
```

## Setup and Run
```bash
cd /Users/shardool/MonoZaius/DrZaiusBackend
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
alembic upgrade head
uvicorn backend.app:app --reload --host 0.0.0.0 --port 8000
```

Health:
```bash
curl -i http://localhost:8000/readyz
curl -i http://localhost:8000/healthz
```

## API Quickstart (curl)

### Auth (signup/login)
```bash
# Signup (role and corpus_uri required)
curl -s -X POST http://localhost:8000/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"username":"userA@example.com","email":"userA@example.com","password":"Passw0rd!","full_name":"User A","role":"caregiver","corpus_uri":"user://userA@example.com/corpus"}'

curl -s -X POST http://localhost:8000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"userA@example.com","password":"Passw0rd!"}'
```

### Groups and Members (pagination)
```bash
# Get token and IDs first (see signup/login)
TOKEN_A="<paste access_token>"
TOKEN_B="<paste access_token>"

# Create group
GROUP_ID=$(curl -s -X POST http://localhost:8000/groups \
  -H "Authorization: Bearer $TOKEN_A" -H "Content-Type: application/json" \
  -d '{"name":"QA Group","description":"Test group"}' | python3 -c 'import sys,json; print(json.load(sys.stdin)["data"]["id"])')

# Add members
USER_A_ID=$(curl -s -H "Authorization: Bearer $TOKEN_A" http://localhost:8000/auth/me | python3 -c 'import sys,json; print(json.load(sys.stdin)["id"])')
USER_B_ID=$(curl -s -H "Authorization: Bearer $TOKEN_B" http://localhost:8000/auth/me | python3 -c 'import sys,json; print(json.load(sys.stdin)["id"])')

curl -i -X POST "http://localhost:8000/groups/$GROUP_ID/access" \
  -H "Authorization: Bearer $TOKEN_A" -H "Content-Type: application/json" \
  -d "{\"userId\":\"$USER_A_ID\",\"role\":\"admin\"}"

curl -i -X POST "http://localhost:8000/groups/$GROUP_ID/access" \
  -H "Authorization: Bearer $TOKEN_A" -H "Content-Type: application/json" \
  -d "{\"userId\":\"$USER_B_ID\",\"role\":\"member\"}"

# List with pagination (check X-Total-Count header)
curl -i "http://localhost:8000/groups/$GROUP_ID/access?limit=1&offset=0" -H "Authorization: Bearer $TOKEN_A"
curl -i "http://localhost:8000/groups/$GROUP_ID/access?limit=1&offset=1" -H "Authorization: Bearer $TOKEN_A"
```

### Invitations (send/list/accept/decline/token)
```bash
# Assumes USER_A_ID (caregiver) and USER_B_ID (recipient) from earlier

# Caregiver → Recipient: send invite
curl -s -X POST "http://localhost:8000/caregivers/$USER_A_ID/invitations" \
  -H "Authorization: Bearer $TOKEN_A" -H "Content-Type: application/json" \
  -d "{\"email\":\"userB@example.com\"}"

# Caregiver: list invites they sent
curl -s "http://localhost:8000/caregivers/$USER_A_ID/invitations" \
  -H "Authorization: Bearer $TOKEN_A"

# Recipient: list received invites
curl -s "http://localhost:8000/recipients/$USER_B_ID/invitations" \
  -H "Authorization: Bearer $TOKEN_B"

# Extract an invitationId (no jq)
INV_ID=$(curl -s "http://localhost:8000/recipients/$USER_B_ID/invitations" -H "Authorization: Bearer $TOKEN_B" \
  | python3 -c 'import sys,json; data=json.load(sys.stdin); print((data.get("items") or [{}])[0].get("id",""))')
echo "INV_ID=$INV_ID"

# Recipient: accept
curl -i -X POST "http://localhost:8000/recipients/$USER_B_ID/invitations/$INV_ID/accept" \
  -H "Authorization: Bearer $TOKEN_B"

# Or decline
curl -i -X POST "http://localhost:8000/recipients/$USER_B_ID/invitations/$INV_ID/decline" \
  -H "Authorization: Bearer $TOKEN_B"

# Recipient → Caregiver: send invite
curl -s -X POST "http://localhost:8000/recipients/$USER_B_ID/invitations" \
  -H "Authorization: Bearer $TOKEN_B" -H "Content-Type: application/json" \
  -d "{\"email\":\"userA@example.com\"}"

# Caregiver: accept/decline received invite by id
INV2=$(curl -s "http://localhost:8000/caregivers/$USER_A_ID/invitations" -H "Authorization: Bearer $TOKEN_A" \
  | python3 -c 'import sys,json; data=json.load(sys.stdin); print((data.get("items") or [{}])[0].get("id",""))')
echo "INV2=$INV2"
curl -i -X POST "http://localhost:8000/caregivers/$USER_A_ID/invitations/$INV2/accept" \
  -H "Authorization: Bearer $TOKEN_A"

# Or caregiver decline
curl -i -X POST "http://localhost:8000/caregivers/$USER_A_ID/invitations/$INV2/decline" \
  -H "Authorization: Bearer $TOKEN_A"

# Public accept by signed token (deep link flow)
# (Assumes your email sender includes a token; for manual test, reuse server-generated token)
TOKEN_STR="<paste_token_here>"
curl -i -X POST "http://localhost:8000/invites/accept-by-token" \
  -H "Content-Type: application/json" \
  -d "{\"token\":\"$TOKEN_STR\"}"
```

### Payment Codes (create/list/void/redeem)
```bash
# Create
CODE=$(curl -s -X POST "http://localhost:8000/groups/$GROUP_ID/payments/codes" \
  -H "Authorization: Bearer $TOKEN_A" -H "Content-Type: application/json" \
  -d '{"ttl_minutes":30}' | python3 -c 'import sys,json; print(json.load(sys.stdin).get("code",""))')
echo "CODE=$CODE"

# List
curl -s "http://localhost:8000/groups/$GROUP_ID/payments/codes" -H "Authorization: Bearer $TOKEN_A"

# Void
curl -i -X POST "http://localhost:8000/groups/$GROUP_ID/payments/codes/$CODE/void" -H "Authorization: Bearer $TOKEN_A"

# Redeem (B)
curl -i -X POST "http://localhost:8000/payments/redeem" \
  -H "Authorization: Bearer $TOKEN_B" -H "Content-Type: application/json" \
  -d "{\"code\":\"$CODE\"}"
```

### Redaction (stub)
```bash
curl -i -X POST "http://localhost:8000/redaction/test" \
  -H "Authorization: Bearer $TOKEN_A" -H "Content-Type: application/json" \
  -d '{"text":"SSN 123-45-6789 and john@example.com"}'
```

## API Routes
See API routes by area and HTTP verbs in:
- API_ROUTES.md
  - Note: Security APIs are present but pending finalization for MVP; DLP/Vertex integrations are also pending and will be completed before launch.

## Error Handling
- Request ID: every response includes `X-Request-Id`; global exception handler logs with it.
- Validation errors: 400 with `{"message":"invalid_payload","details":[...]}`.
- Domain errors: routers map service `ValueError(Errors.*)` to proper HTTP codes.
- Upload validation (size/MIME) returns 413/415 accordingly.

## Design
- Separation of Concerns: routers (I/O), services (business logic), repositories (data access).
- Dependency Injection: services accept repositories; routers provide via small providers.
- Constants: `backend/core/constants.py` centralizes routes, messages, errors, roles, headers.
- Pydantic response models enforce consistent shapes.

# DrZaius Backend

## Development
Run with:

```bash
uvicorn backend.app:app --reload
```

### Configuration
- Create a `.env` file (see example values below):

```
DATABASE_URL=postgresql+psycopg2://postgres:postgres@localhost:5432/drzaius
AUTO_CREATE_DB=false
```

### Database
- Install dependencies:
```
pip install -r requirements.txt
```
- To bootstrap tables for local dev without migrations, set `AUTO_CREATE_DB=true` in `.env` and start the app once.
- Recommended: use Alembic for migrations (`alembic init` then generate revisions).